<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Board.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JeuMines</a> &gt; <a href="index.source.html" class="el_package">main.java.mines</a> &gt; <span class="el_source">Board.java</span></div><h1>Board.java</h1><pre class="source lang-java linenums">package main.java.mines;

import java.awt.Graphics;
import java.awt.Image;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.util.Arrays;
import java.util.Random;

import javax.swing.ImageIcon;
import javax.swing.JLabel;
import javax.swing.JPanel;

public class Board extends JPanel {

    private static final long serialVersionUID = 6195235521361212179L;

    private static final int NUM_IMAGES = 15;  
    private static final int CELL_SIZE = 15;

    /* ---- cell values ----------------------------------------------------- */
    private static final int COVER_FOR_CELL = 10;
    private static final int MARK_FOR_CELL   = 10;
    private static final int EMPTY_CELL      = 0;
    private static final int MINE_CELL       = 9;

    private static final int COVERED_MINE_CELL = MINE_CELL + COVER_FOR_CELL;
    private static final int MARKED_MINE_CELL  = COVERED_MINE_CELL + MARK_FOR_CELL;

    /* ---- drawing indices ------------------------------------------------- */
    private static final int DRAW_MINE           = 9;
    private static final int DRAW_COVER          = 10;
    private static final int DRAW_MARK_P1        = 11;  // Player 1 correct flag
    private static final int DRAW_WRONG_MARK_P1  = 12;  // Player 1 wrong flag
    private static final int DRAW_MARK_P2        = 13;  // Player 2 correct flag
    private static final int DRAW_WRONG_MARK_P2  = 14;  // Player 2 wrong flag

    /* ---- board state ----------------------------------------------------- */
    private int[] field;
    private int[] markers; // -1 = none, 0 = P1, 1 = P2
    private boolean inGame;
    private int minesLeft;
    private transient Image[] img;

<span class="fc" id="L45">    private int mines = 40;</span>
<span class="fc" id="L46">    private int rows  = 16;</span>
<span class="fc" id="L47">    private int cols  = 16;</span>
    private int allCells;

    private final JLabel statusbar;
<span class="fc" id="L51">    private final Random random = new Random();</span>

    /* ---- 2-player state -------------------------------------------------- */
<span class="fc" id="L54">    private int currentPlayer = 0;</span>
<span class="fc" id="L55">    private int[] playerFlags = new int[2];</span>
<span class="fc" id="L56">    private boolean gameWon = false;</span>

    /* --------------------------------------------------------------------- */
<span class="fc" id="L59">    public Board(JLabel statusbar) {</span>
<span class="fc" id="L60">        this.statusbar = statusbar;</span>

<span class="fc" id="L62">        img = new Image[NUM_IMAGES];</span>
<span class="fc bfc" id="L63" title="All 2 branches covered.">        for (int i = 0; i &lt; NUM_IMAGES; i++) {</span>
<span class="fc" id="L64">            img[i] = new ImageIcon(</span>
<span class="fc" id="L65">                    getClass().getClassLoader().getResource(i + &quot;.gif&quot;)</span>
<span class="fc" id="L66">            ).getImage();</span>
        }

<span class="fc" id="L69">        setDoubleBuffered(true);</span>
<span class="fc" id="L70">        addMouseListener(new MinesAdapter());</span>
<span class="fc" id="L71">        newGame();</span>
<span class="fc" id="L72">    }</span>

    /* --------------------------------------------------------------------- */
    public void newGame() {
<span class="fc" id="L76">        initializeBoard();</span>
<span class="fc" id="L77">        placeMinesRandomly();</span>
<span class="fc" id="L78">        updateNeighborCounts();</span>
<span class="fc" id="L79">    }</span>

    private void initializeBoard() {
<span class="fc" id="L82">        inGame = true;</span>
<span class="fc" id="L83">        minesLeft = mines;</span>
<span class="fc" id="L84">        allCells = rows * cols;</span>
<span class="fc" id="L85">        field = new int[allCells];</span>

<span class="fc" id="L87">        Arrays.fill(field, COVER_FOR_CELL);</span>
<span class="fc" id="L88">        markers = new int[allCells];</span>
<span class="fc" id="L89">        Arrays.fill(markers, -1);</span>
<span class="fc" id="L90">        playerFlags[0] = playerFlags[1] = 0;</span>
<span class="fc" id="L91">        currentPlayer = 0;</span>
<span class="fc" id="L92">        gameWon = false;</span>
<span class="fc" id="L93">        statusbar.setText(getStatusText());</span>
<span class="fc" id="L94">    }</span>

    private String getStatusText() {
<span class="fc" id="L97">        return &quot;Player &quot; + (currentPlayer + 1) + &quot;'s turn | Mines left: &quot; + minesLeft +</span>
<span class="fc" id="L98">               &quot; | Flags: P1=&quot; + playerFlags[0] + &quot; P2=&quot; + playerFlags[1];</span>
    }

    private void placeMinesRandomly() {
<span class="fc" id="L102">        int placed = 0;</span>
<span class="fc bfc" id="L103" title="All 2 branches covered.">        while (placed &lt; mines) {</span>
<span class="fc" id="L104">            int pos = random.nextInt(allCells);</span>
<span class="fc bfc" id="L105" title="All 2 branches covered.">            if (field[pos] == COVER_FOR_CELL) {</span>
<span class="fc" id="L106">                field[pos] = COVERED_MINE_CELL;</span>
<span class="fc" id="L107">                placed++;</span>
            }
        }
<span class="fc" id="L110">    }</span>

    private void updateNeighborCounts() {
<span class="fc bfc" id="L113" title="All 2 branches covered.">        for (int pos = 0; pos &lt; allCells; pos++) {</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">            if (field[pos] == COVERED_MINE_CELL) {</span>
<span class="fc" id="L115">                incrementNeighbors(pos);</span>
            }
        }
<span class="fc" id="L118">    }</span>

    public void incrementNeighbors(int minePos) {
<span class="fc" id="L121">        int row = minePos / cols;</span>
<span class="fc" id="L122">        int col = minePos % cols;</span>

<span class="fc bfc" id="L124" title="All 2 branches covered.">        for (int dr = -1; dr &lt;= 1; dr++) {</span>
<span class="fc bfc" id="L125" title="All 2 branches covered.">            for (int dc = -1; dc &lt;= 1; dc++) {</span>
<span class="fc bfc" id="L126" title="All 4 branches covered.">                if (dr == 0 &amp;&amp; dc == 0) continue;</span>

<span class="fc" id="L128">                int nr = row + dr;</span>
<span class="fc" id="L129">                int nc = col + dc;</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">                if (isValidCell(nr, nc)) {</span>
<span class="fc" id="L131">                    int neighborPos = nr * cols + nc;</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">                    if (field[neighborPos] != COVERED_MINE_CELL) {</span>
<span class="fc" id="L133">                        field[neighborPos]++;</span>
                    }
                }
            }
        }
<span class="fc" id="L138">    }</span>

    private boolean isValidCell(int row, int col) {
<span class="fc bfc" id="L141" title="All 8 branches covered.">        return row &gt;= 0 &amp;&amp; row &lt; rows &amp;&amp; col &gt;= 0 &amp;&amp; col &lt; cols;</span>
    }

    /* --------------------------------------------------------------------- */
    public void findEmptyCells(int pos) {
<span class="fc" id="L146">        int row = pos / cols;</span>
<span class="fc" id="L147">        int col = pos % cols;</span>

<span class="fc bfc" id="L149" title="All 2 branches covered.">        for (int dr = -1; dr &lt;= 1; dr++) {</span>
<span class="fc bfc" id="L150" title="All 2 branches covered.">            for (int dc = -1; dc &lt;= 1; dc++) {</span>
<span class="fc bfc" id="L151" title="All 4 branches covered.">                if (dr == 0 &amp;&amp; dc == 0) continue;</span>

<span class="fc" id="L153">                int nr = row + dr;</span>
<span class="fc" id="L154">                int nc = col + dc;</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">                if (!isValidCell(nr, nc)) continue;</span>

<span class="fc" id="L157">                int neighbour = nr * cols + nc;</span>

                // Only reveal covered safe cells (10â€“18)
<span class="pc bpc" id="L160" title="2 of 4 branches missed.">                if (field[neighbour] &gt; MINE_CELL &amp;&amp; field[neighbour] &lt; COVERED_MINE_CELL) {</span>
<span class="fc" id="L161">                    field[neighbour] -= COVER_FOR_CELL;</span>

<span class="pc bpc" id="L163" title="1 of 2 branches missed.">                    if (field[neighbour] == EMPTY_CELL) {</span>
<span class="nc" id="L164">                        findEmptyCells(neighbour);</span>
                    }
                }
            }
        }
<span class="fc" id="L169">    }</span>

    /* --------------------------------------------------------------------- */
    @Override
    public void paint(Graphics g) {
<span class="nc" id="L174">        int numCovers = 0;</span>

<span class="nc bnc" id="L176" title="All 2 branches missed.">        for (int i = 0; i &lt; rows; i++) {</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">            for (int j = 0; j &lt; cols; j++) {</span>
<span class="nc" id="L178">                int idx = i * cols + j;</span>
<span class="nc" id="L179">                int cell = field[idx];</span>
<span class="nc" id="L180">                int marker = markers[idx];</span>

                // Lose condition
<span class="nc bnc" id="L183" title="All 4 branches missed.">                if (inGame &amp;&amp; cell == MINE_CELL) {</span>
<span class="nc" id="L184">                    inGame = false;</span>
                }

                // Determine image to draw
                int drawIndex;

<span class="nc bnc" id="L190" title="All 2 branches missed.">                if (!inGame) {</span>
                    // Game over: show truth
<span class="nc bnc" id="L192" title="All 2 branches missed.">                    if (cell == COVERED_MINE_CELL) {</span>
<span class="nc" id="L193">                        drawIndex = DRAW_MINE;</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">                    } else if (cell == MARKED_MINE_CELL) {</span>
                        // Correct flag: show player's flag
<span class="nc bnc" id="L196" title="All 2 branches missed.">                        drawIndex = (marker == 0) ? DRAW_MARK_P1 : DRAW_MARK_P2;</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">                    } else if (cell &gt; COVERED_MINE_CELL) {</span>
                        // Wrong flag
<span class="nc bnc" id="L199" title="All 2 branches missed.">                        drawIndex = (marker == 0) ? DRAW_WRONG_MARK_P1 : DRAW_WRONG_MARK_P2;</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">                    } else if (cell &gt; MINE_CELL) {</span>
<span class="nc" id="L201">                        drawIndex = DRAW_COVER;</span>
<span class="nc" id="L202">                    } else {</span>
<span class="nc" id="L203">                        drawIndex = cell; // revealed number or empty</span>
                    }
<span class="nc" id="L205">                } else {</span>
                    // In game
<span class="nc bnc" id="L207" title="All 2 branches missed.">                    if (cell &gt; COVERED_MINE_CELL) {</span>
                        // Flagged cell
<span class="nc bnc" id="L209" title="All 2 branches missed.">                        drawIndex = (marker == 0) ? DRAW_MARK_P1 : DRAW_MARK_P2;</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">                    } else if (cell &gt; MINE_CELL) {</span>
<span class="nc" id="L211">                        drawIndex = DRAW_COVER;</span>
<span class="nc" id="L212">                        numCovers++;</span>
<span class="nc" id="L213">                    } else {</span>
<span class="nc" id="L214">                        drawIndex = cell; // revealed</span>
                    }
                }

<span class="nc" id="L218">                g.drawImage(img[drawIndex], j * CELL_SIZE, i * CELL_SIZE, this);</span>
            }
        }

        // Win condition
<span class="nc bnc" id="L223" title="All 4 branches missed.">        if (numCovers == 0 &amp;&amp; inGame) {</span>
<span class="nc" id="L224">            inGame = false;</span>
<span class="nc" id="L225">            gameWon = true;</span>
        }

        // Update status
<span class="nc bnc" id="L229" title="All 2 branches missed.">        if (!inGame) {</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">            if (gameWon) {</span>
<span class="nc" id="L231">                int p1 = playerFlags[0], p2 = playerFlags[1];</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">                String result = p1 &gt; p2 ? &quot; Player 1 wins!&quot; :</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">                               p2 &gt; p1 ? &quot; Player 2 wins!&quot; : &quot; It's a draw!&quot;;</span>
<span class="nc" id="L234">                statusbar.setText(&quot;Game won! P1: &quot; + p1 + &quot; | P2: &quot; + p2 + result);</span>
<span class="nc" id="L235">            } else {</span>
<span class="nc" id="L236">                int loser = currentPlayer;</span>
<span class="nc" id="L237">                int winner = 1 - loser;</span>
<span class="nc" id="L238">                statusbar.setText(&quot;Player &quot; + (loser + 1) + &quot; hit a mine! Player &quot; + (winner + 1) + &quot; wins!&quot;);</span>
            }
<span class="nc" id="L240">        } else {</span>
<span class="nc" id="L241">            statusbar.setText(getStatusText());</span>
        }
<span class="nc" id="L243">    }</span>

    /* --------------------------------------------------------------------- */
<span class="fc" id="L246">    public static int getCoverForCell()   { return COVER_FOR_CELL; }</span>
<span class="fc" id="L247">    public static int getCoveredMineCell(){ return COVERED_MINE_CELL; }</span>

    /* --------------------------------------------------------------------- */
<span class="fc" id="L250">    private class MinesAdapter extends MouseAdapter {</span>
        @Override
        public void mousePressed(MouseEvent e) {
<span class="nc bnc" id="L253" title="All 2 branches missed.">            if (!inGame) {</span>
<span class="nc" id="L254">                newGame();</span>
<span class="nc" id="L255">                repaint();</span>
<span class="nc" id="L256">                return;</span>
            }

<span class="nc" id="L259">            int x = e.getX();</span>
<span class="nc" id="L260">            int y = e.getY();</span>
<span class="nc" id="L261">            int cCol = x / CELL_SIZE;</span>
<span class="nc" id="L262">            int cRow = y / CELL_SIZE;</span>

<span class="nc bnc" id="L264" title="All 8 branches missed.">            if (cRow &lt; 0 || cCol &lt; 0 || cRow &gt;= rows || cCol &gt;= cols) return;</span>

<span class="nc" id="L266">            int pos = cRow * cols + cCol;</span>
<span class="nc" id="L267">            boolean repaintNeeded = false;</span>

            // Right-click: Flag / Unflag
<span class="nc bnc" id="L270" title="All 2 branches missed.">            if (e.getButton() == MouseEvent.BUTTON3) {</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">                if (field[pos] &lt;= MINE_CELL) return; // can't flag revealed</span>

<span class="nc bnc" id="L273" title="All 2 branches missed.">                boolean isMarked = (field[pos] &gt; COVERED_MINE_CELL);</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">                if (isMarked) {</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">                    if (markers[pos] == currentPlayer) {</span>
<span class="nc" id="L276">                        field[pos] -= MARK_FOR_CELL;</span>
<span class="nc" id="L277">                        markers[pos] = -1;</span>
<span class="nc" id="L278">                        playerFlags[currentPlayer]--;</span>
<span class="nc" id="L279">                        minesLeft++;</span>
<span class="nc" id="L280">                        repaintNeeded = true;</span>
<span class="nc" id="L281">                        currentPlayer = 1 - currentPlayer;</span>
                    }
<span class="nc" id="L283">                } else {</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">                    if (minesLeft &gt; 0) {</span>
<span class="nc" id="L285">                        field[pos] += MARK_FOR_CELL;</span>
<span class="nc" id="L286">                        markers[pos] = currentPlayer;</span>
<span class="nc" id="L287">                        playerFlags[currentPlayer]++;</span>
<span class="nc" id="L288">                        minesLeft--;</span>
<span class="nc" id="L289">                        repaintNeeded = true;</span>
<span class="nc" id="L290">                        currentPlayer = 1 - currentPlayer;</span>
                    }
                }
<span class="nc" id="L293">            }</span>
            // Left-click: Reveal
            else {
<span class="nc bnc" id="L296" title="All 2 branches missed.">                if (field[pos] &gt; COVERED_MINE_CELL) return; // can't reveal flagged</span>

<span class="nc" id="L298">                field[pos] -= COVER_FOR_CELL;</span>
<span class="nc" id="L299">                repaintNeeded = true;</span>

<span class="nc bnc" id="L301" title="All 2 branches missed.">                if (field[pos] == MINE_CELL) {</span>
<span class="nc" id="L302">                    inGame = false;</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">                } else if (field[pos] == EMPTY_CELL) {</span>
<span class="nc" id="L304">                    findEmptyCells(pos);</span>
                }

<span class="nc bnc" id="L307" title="All 2 branches missed.">                if (inGame) {</span>
<span class="nc" id="L308">                    currentPlayer = 1 - currentPlayer;</span>
                }
            }

<span class="nc bnc" id="L312" title="All 2 branches missed.">            if (repaintNeeded) {</span>
<span class="nc" id="L313">                repaint();</span>
            }
<span class="nc" id="L315">        }</span>
    }
    
 // Add these getter methods to the Board class
    public int getCurrentPlayer() {
<span class="nc" id="L320">        return currentPlayer;</span>
    }

    public boolean isInGame() {
<span class="nc" id="L324">        return inGame;</span>
    }

    public int getMinesLeft() {
<span class="nc" id="L328">        return minesLeft;</span>
    }

    public int[] getPlayerFlags() {
<span class="nc" id="L332">        return playerFlags.clone(); // Return copy to prevent external modification</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>